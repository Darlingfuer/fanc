#!/usr/bin/env python

import argparse
from kaic.tools.files import copy_or_expand
from kaic.data.genomic import Hic
import kaic.correcting.knight_matrix_balancing as knight
import kaic.correcting.ice_matrix_balancing as ice
import logging
logging.basicConfig(level=logging.DEBUG)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()

    parser.add_argument(
        'input',
        help='''Input Hic file'''
    )

    parser.add_argument(
        'output',
        nargs="?",
        help='''Output Hic file. If not provided will filter existing file in place.'''
    )

    parser.add_argument(
        '-i', '--ice', dest='ice',
        action='store_true',
        help='''Use ICE iterative correction instead of Knight matrix balancing'''
    )
    parser.set_defaults(ice=False)

    parser.add_argument(
        '-c', '--chromosome', dest='chromosome',
        action='store_true',
        help='''Correct intra-chromosomal data individually, ignore inter-chromosomal data'''
    )
    parser.set_defaults(chromosome=False)

    args = parser.parse_args()

    # copy file if required
    input_path = copy_or_expand(args.input, args.output)

    hic = Hic(file_name=input_path)

    if args.ice:
        ice.correct(hic)
    else:
        knight.correct(hic, only_intra_chromosomal=args.chromosome)

    hic.close()
